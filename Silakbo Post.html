<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ANG SILAKBO WORKSTATION</title>
    <link rel="icon" href="SILAKBO.png">
    <!-- Google Fonts - Poppins -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600&display=swap" rel="stylesheet">
    <!-- TinyMCE -->
    <script src="https://cdn.tiny.cloud/1/n92j01vjprp9xy96v0uxd2kgqi5vnd50dwm5i47veg2u1bur/tinymce/6/tinymce.min.js" referrerpolicy="origin"></script>
    <!-- Supabase -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --primary: #E64A19;
            --primary-dark: #C62828;
            --primary-light: #FF8A65;
            --secondary: #F7FAFC;
            --text-dark: #1A202C;
            --text-light: #4A5568;
            --white: #FFFFFF;
            --gray-light: #EDF2F7;
            --gray: #E2E8F0;
            --gray-dark: #CBD5E0;
            --success: #48BB78;
            --error: #F56565;
            --info: #4299E1;
            --border-radius: 8px;
            --shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
            --transition: all 0.2s ease;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Poppins', sans-serif;
        }

        body {
            background: var(--secondary);
            color: var(--text-dark);
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }

        /* Title Bar */
        .title-bar {
            background: var(--white);
            padding: 0.75rem 1.5rem;
            display: flex;
            align-items: center;
            border-bottom: 1px solid var(--gray);
            box-shadow: var(--shadow);
        }

        .title-container {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .title-container img {
            height: 28px;
        }

        .title-container span {
            font-size: 16px;
            font-weight: 600;
            color: var(--text-dark);
        }

        /* Ribbon */
        .ribbon {
            background: var(--white);
            padding: 0.75rem 1.5rem;
            position: sticky;
            top: 0;
            z-index: 1000;
            border-bottom: 1px solid var(--gray);
        }

        .ribbon-container {
            max-width: 1280px;
            margin: 0 auto;
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .ribbon-tabs {
            display: flex;
            gap: 0.5rem;
        }

        .ribbon-tab {
            padding: 0.5rem 1.25rem;
            font-size: 14px;
            font-weight: 500;
            color: var(--text-light);
            cursor: pointer;
            border-radius: var(--border-radius);
            transition: var(--transition);
        }

        .ribbon-tab:hover {
            background: var(--gray-light);
            color: var(--text-dark);
        }

        .ribbon-tab.active {
            background: var(--primary);
            color: var(--white);
        }

        .ribbon-toolbar {
            display: flex;
            gap: 0.75rem;
            align-items: center;
        }

        .ribbon-group {
            display: flex;
            gap: 0.5rem;
        }

        .ribbon-btn {
            background: var(--white);
            border: 1px solid var(--gray);
            padding: 0.5rem 1rem;
            border-radius: var(--border-radius);
            font-size: 13px;
            font-weight: 500;
            color: var(--text-dark);
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            transition: var(--transition);
        }

        .ribbon-btn:hover {
            background: var(--primary);
            color: var(--white);
            border-color: var(--primary);
        }

        .ribbon-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        /* Main Content */
        main {
            max-width: 900px;
            margin: 2rem auto;
            flex: 1;
            background: var(--white);
            border-radius: var(--border-radius);
            box-shadow: var(--shadow);
            padding: 2rem;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        /* Form */
        .form-group {
            margin-bottom: 1.5rem;
        }

        label {
            font-size: 14px;
            font-weight: 500;
            color: var(--text-dark);
            margin-bottom: 0.5rem;
            display: block;
        }

        input[type="text"],
        select {
            width: 100%;
            padding: 0.75rem;
            border: 1px solid var(--gray);
            border-radius: var(--border-radius);
            font-size: 14px;
            transition: var(--transition);
        }

        input[type="text"]:focus,
        select:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(230, 74, 25, 0.1);
        }

        .file-input-container {
            display: flex;
            align-items: center;
            gap: 1rem;
            flex-wrap: wrap;
        }

        .file-input-label {
            padding: 0.5rem 1rem;
            background: var(--primary);
            color: var(--white);
            border-radius: var(--border-radius);
            cursor: pointer;
            font-size: 13px;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            transition: var(--transition);
        }

        .file-input-label:hover {
            background: var(--primary-dark);
        }

        input[type="file"] {
            display: none;
        }

        .file-name {
            font-size: 13px;
            color: var(--text-light);
        }

        .image-preview-container {
            margin-top: 0.75rem;
            max-width: 200px;
        }

        #imagePreview, #editImagePreview {
            max-width: 100%;
            border-radius: var(--border-radius);
            display: none;
            box-shadow: var(--shadow);
        }

        /* Table */
        .table-container {
            border-radius: var(--border-radius);
            overflow-x: auto;
        }

        .posts-table {
            width: 100%;
            border-collapse: separate;
            border-spacing: 0;
        }

        .posts-table th,
        .posts-table td {
            padding: 1rem;
            text-align: left;
            border-bottom: 1px solid var(--gray);
            font-size: 13px;
        }

        .posts-table th {
            background: var(--gray-light);
            font-weight: 500;
            position: sticky;
            top: 0;
        }

        .posts-table tr:hover {
            background: var(--gray-light);
        }

        .action-buttons {
            display: flex;
            gap: 0.5rem;
        }

        .btn-icon {
            width: 32px;
            height: 32px;
            border-radius: var(--border-radius);
            display: flex;
            align-items: center;
            justify-content: center;
            border: none;
            background: transparent;
            cursor: pointer;
            font-size: 14px;
            transition: var(--transition);
        }

        .btn-icon:hover {
            background: var(--primary-light);
            color: var(--white);
        }

        .btn-view { color: var(--success); }
        .btn-edit { color: var(--info); }
        .btn-delete { color: var(--error); }

        /* Alerts */
        .alert {
            padding: 0.75rem 1rem;
            border-radius: var(--border-radius);
            display: none;
            align-items: center;
            gap: 0.5rem;
            margin-bottom: 1.5rem;
            font-size: 13px;
            box-shadow: var(--shadow);
        }

        .alert-success {
            background: var(--success);
            color: var(--white);
        }

        .alert-error {
            background: var(--error);
            color: var(--white);
        }

        .alert-close {
            margin-left: auto;
            background: none;
            border: none;
            cursor: pointer;
            font-size: 14px;
            color: var(--white);
        }

        /* Modals */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }

        .modal {
            background: var(--white);
            border-radius: var(--border-radius);
            max-width: 600px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: var(--shadow);
            transform: translateY(20px);
            transition: transform 0.3s ease, opacity 0.3s ease;
            opacity: 0;
        }

        .modal-overlay.active .modal {
            transform: translateY(0);
            opacity: 1;
        }

        .modal-header {
            padding: 1rem 1.5rem;
            border-bottom: 1px solid var(--gray);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-title {
            font-size: 16px;
            font-weight: 600;
            color: var(--text-dark);
        }

        .modal-close {
            background: none;
            border: none;
            font-size: 16px;
            cursor: pointer;
            color: var(--text-light);
        }

        .modal-body {
            padding: 1.5rem;
        }

        .modal-footer {
            padding: 1rem 1.5rem;
            border-top: 1px solid var(--gray);
            display: flex;
            gap: 0.75rem;
            justify-content: flex-end;
        }

        /* Buttons */
        .btn {
            padding: 0.6rem 1.2rem;
            border: none;
            border-radius: 8px;
            font-size: 13px;
            font-weight: 500;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            transition: var(--transition);
        }

        .btn-primary {
            background: var(--primary);
            color: var(--white);
        }

        .btn-primary:hover {
            background: var(--primary-dark);
        }

        .btn-secondary {
            background: var(--gray-light);
            color: var(--text-dark);
        }

        .btn-secondary:hover {
            background: var(--gray-dark);
        }

        .btn-danger {
            background: var(--error);
            color: var(--white);
        }

        .btn-danger:hover {
            background: #E53E3E;
        }

        /* TinyMCE */
        .tox-tinymce {
            border: 1px solid var(--gray);
            border-radius: 8px !important;
        }

        .tox-tinymce:focus-within {
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(230, 74, 25, 0.1);
        }

        .tox .tox-toolbar__primary {
            background: var(--white);
            border-bottom: 1px solid var(--gray);
        }

        /* Status Bar */
        .status-bar {
            background: var(--white);
            padding: 0.75rem 1.5rem;
            border-top: 1px solid var(--gray);
            font-size: 13px;
            color: var(--text-light);
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: var(--shadow);
        }

        /* Animations */
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .alert {
            animation: fadeIn 0.3s ease;
        }

        /* Responsive */
        @media (max-width: 768px) {
            main {
                margin: 1rem;
                padding: 1.5rem;
            }

            .ribbon-container {
                flex-direction: column;
                align-items: flex-start;
            }

            .ribbon-tabs {
                flex-wrap: wrap;
                width: 100%;
            }

            .ribbon-toolbar {
                width: 100%;
                justify-content: flex-start;
            }

            .ribbon-btn {
                flex: 1;
                justify-content: center;
            }
        }

        @media (max-width: 576px) {
            .form-group {
                margin-bottom: 1rem;
            }

            .btn {
                width: 100%;
                justify-content: center;
            }

            .modal {
                width: 95%;
            }
        }
    </style>
</head>
<body>
    <div class="title-bar">
        <div class="title-container">
            <img src="SILAKBO.png" alt="Silakbo Logo">
            <span>ANG SILAKBO WORKSTATION</span>
        </div>
    </div>

    <header class="ribbon">
        <div class="ribbon-container">
            <div class="ribbon-tabs">
                <div class="ribbon-tab active" data-tab="create">New Post</div>
                <div class="ribbon-tab" data-tab="manage">Manage Posts</div>
            </div>
            <div class="ribbon-toolbar" id="createToolbar">
                <div class="ribbon-group">
                    <button class="ribbon-btn" id="submitBtn">
                        <i class="fas fa-save"></i> Publish
                    </button>
                    <button class="ribbon-btn" id="clearFormBtn">
                        <i class="fas fa-eraser"></i> Reset
                    </button>
                </div>
            </div>
            <div class="ribbon-toolbar" id="manageToolbar" style="display: none;">
                <div class="ribbon-group">
                    <button class="ribbon-btn" id="refreshPosts">
                        <i class="fas fa-sync"></i> Refresh
                    </button>
                </div>
            </div>
        </div>
    </header>

    <main>
        <div class="alert alert-success" id="alertSuccess">
            <i class="fas fa-check-circle"></i>
            <span>Success!</span>
            <button class="alert-close">×</button>
        </div>
        <div class="alert alert-error" id="alertError">
            <i class="fas fa-exclamation-circle"></i>
            <span id="errorMessage">Error occurred.</span>
            <button class="alert-close">×</button>
        </div>

        <div class="tab-content active" id="createTab">
            <form id="postForm">
                <div class="form-group">
                    <label for="title">Title</label>
                    <input type="text" id="title" required placeholder="Enter post title">
                </div>
                <div class="form-group">
                    <label for="category">Category</label>
                    <select id="category" required>
                        <option value="article">Article</option>
                        <option value="literary">Literary</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="author">Author</label>
                    <input type="text" id="author" required placeholder="Enter author's name">
                </div>
                <div class="form-group">
                    <label id="roleLabel" for="additionalField">Photojournalist</label>
                    <input type="text" id="additionalField" placeholder="Enter photojournalist's name">
                </div>
                <div class="form-group">
                    <label for="imageUpload">Image</label>
                    <div class="file-input-container">
                        <label class="file-input-label">
                            <i class="fas fa-upload"></i> Upload Image
                            <input type="file" id="imageUpload" accept="image/*">
                        </label>
                        <span class="file-name" id="fileName">
                            <i class="fas fa-file-image"></i> No image selected
                        </span>
                    </div>
                    <div class="image-preview-container">
                        <img id="imagePreview" alt="Image Preview">
                    </div>
                </div>
                <div class="form-group">
                    <label for="content">Content</label>
                    <textarea id="content"></textarea>
                </div>
            </form>
        </div>

        <div class="tab-content" id="manageTab">
            <div id="postsTableContainer">
                <div id="loadingPosts" class="loading-container">
                    <div class="loading-spinner"></div>
                    <p>Loading posts...</p>
                </div>
                <div class="table-container" id="postsTable" style="display: none;">
                    <table class="posts-table">
                        <thead>
                            <tr>
                                <th>Title</th>
                                <th>Category</th>
                                <th>Author</th>
                                <th>Role</th>
                                <th>Date</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="postsTableBody"></tbody>
                    </table>
                </div>
                <div id="noPostsMessage" class="empty-state" style="display: none;">
                    <i class="fas fa-inbox"></i>
                    <p>No posts found.</p>
                    <button class="btn btn-primary" id="createFirstPostBtn">
                        <i class="fas fa-plus-circle"></i> Create Post
                    </button>
                </div>
            </div>
        </div>
    </main>

    <div class="status-bar">
        <span id="statusMessage">Ready</span>
        <span>Words: <span id="wordCount">0</span></span>
    </div>

    <div class="modal-overlay" id="editModal">
        <div class="modal">
            <div class="modal-header">
                <h3 class="modal-title">Edit Post</h3>
                <button class="modal-close" id="closeEditModal">×</button>
            </div>
            <div class="modal-body">
                <form id="editForm">
                    <input type="hidden" id="editPostId">
                    <div class="form-group">
                        <label for="editTitle">Title</label>
                        <input type="text" id="editTitle" required placeholder="Enter post title">
                    </div>
                    <div class="form-group">
                        <label for="editCategory">Category</label>
                        <select id="editCategory" required>
                            <option value="article">Article</option>
                            <option value="literary">Literary</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="editAuthor">Author</label>
                        <input type="text" id="editAuthor" required placeholder="Enter author's name">
                    </div>
                    <div class="form-group">
                        <label id="editRoleLabel" for="editAdditionalField">Photojournalist</label>
                        <input type="text" id="editAdditionalField" placeholder="Enter photojournalist's name">
                    </div>
                    <div class="form-group">
                        <label for="editImageUpload">Image</label>
                        <div class="file-input-container">
                            <label class="file-input-label">
                                <i class="fas fa-upload"></i> Upload Image
                                <input type="file" id="editImageUpload" accept="image/*">
                            </label>
                            <span class="file-name" id="editFileName">
                                <i class="fas fa-file-image"></i> No image selected
                            </span>
                        </div>
                        <div class="image-preview-container">
                            <img id="editImagePreview" alt="Image Preview">
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="editContent">Content</label>
                        <textarea id="editContent"></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" id="cancelEditBtn">Cancel</button>
                <button class="btn btn-primary" id="saveEditBtn">
                    <span class="spinner" id="editSpinner"></span> Save
                </button>
            </div>
        </div>
    </div>

    <div class="modal-overlay" id="deleteModal">
        <div class="modal">
            <div class="modal-header">
                <h3 class="modal-title">Delete Post</h3>
                <button class="modal-close" id="closeDeleteModal">×</button>
            </div>
            <div class="modal-body">
                <p>Are you sure you want to delete this post?</p>
                <input type="hidden" id="deletePostId">
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" id="cancelDeleteBtn">Cancel</button>
                <button class="btn btn-danger" id="confirmDeleteBtn">
                    <span class="spinner" id="deleteSpinner"></span> Delete
                </button>
            </div>
        </div>
    </div>

    <div class="modal-overlay" id="viewModal">
        <div class="modal">
            <div class="modal-header">
                <h3 class="modal-title">View Post</h3>
                <button class="modal-close" id="closeViewModal">×</button>
            </div>
            <div class="modal-body">
                <div id="viewPostContent"></div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" id="closeViewBtn">Close</button>
                <button class="btn btn-primary" id="editFromViewBtn">Edit</button>
            </div>
        </div>
    </div>

    <script>
        // Initialize Supabase
        const supabaseUrl = "https://uyxgsziyflquisckdwwc.supabase.co";
        const supabaseKey = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InV5eGdzeml5ZmxxdWlzY2tkd3djIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDE1OTQyODUsImV4cCI6MjA1NzE3MDI4NX0.DoIEoWWuajDpBhD2UwLYzrKRyZNyBP4izasROCdIbkk";
        const supabase = window.supabase.createClient(supabaseUrl, supabaseKey);

        // Initialize TinyMCE
        document.addEventListener('DOMContentLoaded', function() {
            tinymce.init({
                selector: '#content, #editContent',
                plugins: 'anchor autolink charmap codesample emoticons image link lists media searchreplace table visualblocks wordcount',
                toolbar: 'undo redo | blocks fontsize | bold italic underline strikethrough | link image media table | align lineheight | numlist bullist indent outdent | emoticons charmap | removeformat',
                height: 400,
                menubar: false,
                statusbar: false,
                branding: false,
                promotion: false,
                content_css: 'default',
                setup: function(editor) {
                    editor.on('keyup change', function() {
                        const content = editor.getContent({ format: 'text' });
                        const wordCount = content.trim().split(/\s+/).filter(word => word.length > 0).length;
                        document.getElementById('wordCount').textContent = wordCount;
                    });
                }
            });

            loadPosts();
            updateStatus('Ready');

            document.getElementById('category').addEventListener('change', function() {
                document.getElementById('roleLabel').textContent = this.value === 'article' ? 'Photojournalist' : 'Cartoonist';
            });

            document.getElementById('editCategory').addEventListener('change', function() {
                document.getElementById('editRoleLabel').textContent = this.value === 'article' ? 'Photojournalist' : 'Cartoonist';
            });

            document.getElementById('clearFormBtn').addEventListener('click', function() {
                document.getElementById('postForm').reset();
                tinymce.get('content').setContent('');
                document.getElementById('imagePreview').style.display = 'none';
                document.getElementById('fileName').innerHTML = '<i class="fas fa-file-image"></i> No image selected';
                updateStatus('Form reset');
            });
        });

        // Ribbon Tabs
        document.addEventListener('DOMContentLoaded', () => {
            const tabs = document.querySelectorAll('.ribbon-tab');
            const tabContents = document.querySelectorAll('.tab-content');
            const toolbars = document.querySelectorAll('.ribbon-toolbar');

            tabs.forEach(tab => {
                tab.addEventListener('click', () => {
                    const tabId = tab.getAttribute('data-tab');
                    tabs.forEach(t => t.classList.remove('active'));
                    tab.classList.add('active');
                    tabContents.forEach(content => content.classList.remove('active'));
                    document.getElementById(`${tabId}Tab`).classList.add('active');
                    toolbars.forEach(toolbar => toolbar.style.display = 'none');
                    document.getElementById(`${tabId}Toolbar`).style.display = 'flex';
                    if (tabId === 'manage') loadPosts();
                    updateStatus(tabId === 'create' ? 'Ready to create' : 'Viewing posts');
                });
            });

            document.getElementById('createFirstPostBtn').addEventListener('click', () => {
                document.querySelector('.ribbon-tab[data-tab="create"]').click();
            });

            document.getElementById('refreshPosts').addEventListener('click', () => {
                loadPosts();
                updateStatus('Posts refreshed');
            });
        });

        // Image Preview
        ['imageUpload', 'editImageUpload'].forEach(id => {
            document.getElementById(id).addEventListener('change', function(event) {
                const file = event.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        const imgPreview = document.getElementById(id === 'imageUpload' ? 'imagePreview' : 'editImagePreview');
                        imgPreview.src = e.target.result;
                        imgPreview.style.display = 'block';
                        document.getElementById(id === 'imageUpload' ? 'fileName' : 'editFileName').innerHTML = 
                            `<i class="fas fa-file-image"></i> ${file.name}`;
                        updateStatus('Image selected');
                    };
                    reader.readAsDataURL(file);
                }
            });
        });

        // Form Submission
        document.getElementById('postForm').addEventListener('submit', async function(event) {
            event.preventDefault();
        });

        document.getElementById('submitBtn').addEventListener('click', async function() {
            const submitBtn = this;
            submitBtn.disabled = true;
            updateStatus('Publishing...');

            try {
                const category = document.getElementById('category').value;
                const title = document.getElementById('title').value;
                const author = document.getElementById('author').value;
                const role = document.getElementById('additionalField').value;
                const content = tinymce.get('content').getContent();
                const imageFile = document.getElementById('imageUpload').files[0];

                let imageUrl = '';
                if (imageFile) {
                    const formData = new FormData();
                    formData.append("file", imageFile);
                    formData.append("upload_preset", "Ang Silakbo");
                    const response = await fetch("https://api.cloudinary.com/v1_1/ddalveuw6/image/upload", {
                        method: "POST",
                        body: formData
                    });
                    const data = await response.json();
                    if (data.error) throw new Error(data.error.message);
                    imageUrl = data.secure_url;
                }

                const { error } = await supabase.from("posts").insert([{ 
                    category, title, author, role, content, image_url: imageUrl, created_at: new Date().toISOString()
                }]);

                if (error) throw new Error(error.message);

                showAlert('success', 'Post published successfully!');
                document.getElementById('postForm').reset();
                tinymce.get('content').setContent('');
                document.getElementById('imagePreview').style.display = 'none';
                document.getElementById('fileName').innerHTML = '<i class="fas fa-file-image"></i> No image selected';
                if (document.getElementById('manageTab').classList.contains('active')) loadPosts();
                updateStatus('Published');
            } catch (error) {
                showAlert('error', error.message || 'Error publishing post.');
                updateStatus('Error');
            } finally {
                submitBtn.disabled = false;
            }
        });

        // Load Posts
        async function loadPosts() {
            const loadingElement = document.getElementById('loadingPosts');
            const tableElement = document.getElementById('postsTable');
            const noPostsMessage = document.getElementById('noPostsMessage');
            loadingElement.style.display = 'block';
            tableElement.style.display = 'none';
            noPostsMessage.style.display = 'none';
            updateStatus('Loading posts...');

            try {
                const { data, error } = await supabase.from('posts').select('*').order('created_at', { ascending: false });
                if (error) throw new Error(error.message);

                const tableBody = document.getElementById('postsTableBody');
                tableBody.innerHTML = '';

                if (data && data.length > 0) {
                    data.forEach(post => {
                        const row = document.createElement('tr');
                        const date = new Date(post.created_at);
                        const formattedDate = date.toLocaleDateString();
                        row.innerHTML = `
                            <td>${post.title || 'Untitled'}</td>
                            <td>${post.category.charAt(0).toUpperCase() + post.category.slice(1)}</td>
                            <td>${post.author}</td>
                            <td>${post.role || '-'}</td>
                            <td>${formattedDate}</td>
                            <td>
                                <div class="action-buttons">
                                    <button class="btn-icon btn-view" data-id="${post.id}"><i class="fas fa-eye"></i></button>
                                    <button class="btn-icon btn-edit" data-id="${post.id}"><i class="fas fa-edit"></i></button>
                                    <button class="btn-icon btn-delete" data-id="${post.id}"><i class="fas fa-trash-alt"></i></button>
                                </div>
                            </td>
                        `;
                        tableBody.appendChild(row);
                    });

                    tableElement.style.display = 'block';
                    document.querySelectorAll('.btn-view').forEach(button => button.addEventListener('click', () => openViewModal(button.getAttribute('data-id'))));
                    document.querySelectorAll('.btn-edit').forEach(button => button.addEventListener('click', () => openEditModal(button.getAttribute('data-id'))));
                    document.querySelectorAll('.btn-delete').forEach(button => button.addEventListener('click', () => openDeleteModal(button.getAttribute('data-id'))));
                    updateStatus('Posts loaded');
                } else {
                    noPostsMessage.style.display = 'block';
                    updateStatus('No posts found');
                }
            } catch (error) {
                showAlert('error', error.message || 'Error loading posts.');
                updateStatus('Error');
            } finally {
                loadingElement.style.display = 'none';
            }
        }

        // View Modal
        async function openViewModal(postId) {
            try {
                const { data, error } = await supabase.from('posts').select('*').eq('id', postId).single();
                if (error) throw new Error(error.message);

                const viewContent = document.getElementById('viewPostContent');
                const date = new Date(data.created_at);
                const formattedDate = date.toLocaleDateString();
                let html = `
                    <h2 style="font-size: 18px; margin-bottom: 0.75rem;">${data.title || 'Untitled'}</h2>
                    <div style="font-size: 13px; color: var(--text-light); margin-bottom: 1rem;">
                        <div><strong>Category:</strong> ${data.category.charAt(0).toUpperCase() + data.category.slice(1)}</div>
                        <div><strong>Author:</strong> ${data.author}</div>
                        <div><strong>${data.category === 'article' ? 'Photojournalist' : 'Cartoonist'}:</strong> ${data.role || '-'}</div>
                        <div><strong>Date:</strong> ${formattedDate}</div>
                    </div>
                `;
                if (data.image_url) {
                    html += `<img src="${data.image_url}" alt="Post Image" style="max-width: 100%; border-radius: 8px; margin-bottom: 1rem;">`;
                }
                html += `<div style="font-size: 14px;">${data.content}</div>`;
                viewContent.innerHTML = html;
                document.getElementById('editFromViewBtn').setAttribute('data-id', postId);
                document.getElementById('viewModal').classList.add('active');
                document.getElementById('viewModal').style.display = 'flex';
                updateStatus('Viewing post');
            } catch (error) {
                showAlert('error', error.message || 'Error loading post.');
                updateStatus('Error');
            }
        }

        // Edit Modal
        async function openEditModal(postId) {
            try {
                const { data, error } = await supabase.from('posts').select('*').eq('id', postId).single();
                if (error) throw new Error(error.message);

                document.getElementById('editPostId').value = data.id;
                document.getElementById('editCategory').value = data.category;
                document.getElementById('editTitle').value = data.title || '';
                document.getElementById('editAuthor').value = data.author;
                document.getElementById('editAdditionalField').value = data.role || '';
                document.getElementById('editRoleLabel').textContent = data.category === 'article' ? 'Photojournalist' : 'Cartoonist';
                tinymce.get('editContent').setContent(data.content || '');
                const imgPreview = document.getElementById('editImagePreview');
                if (data.image_url) {
                    imgPreview.src = data.image_url;
                    imgPreview.style.display = 'block';
                } else {
                    imgPreview.style.display = 'none';
                }
                document.getElementById('editFileName').innerHTML = '<i class="fas fa-file-image"></i> No image selected';
                document.getElementById('editModal').classList.add('active');
                document.getElementById('editModal').style.display = 'flex';
                updateStatus('Editing post');
            } catch (error) {
                showAlert('error', error.message || 'Error loading post.');
                updateStatus('Error');
            }
        }

        // Save Edit
        document.getElementById('saveEditBtn').addEventListener('click', async function() {
            const saveBtn = this;
            saveBtn.disabled = true;
            updateStatus('Saving changes...');

            try {
                const postId = document.getElementById('editPostId').value;
                const category = document.getElementById('editCategory').value;
                const title = document.getElementById('editTitle').value;
                const author = document.getElementById('editAuthor').value;
                const role = document.getElementById('editAdditionalField').value;
                const content = tinymce.get('editContent').getContent();
                const imageFile = document.getElementById('editImageUpload').files[0];

                let updateData = { category, title, author, role, content, updated_at: new Date().toISOString() };

                if (imageFile) {
                    const formData = new FormData();
                    formData.append("file", imageFile);
                    formData.append("upload_preset", "Ang Silakbo");
                    const response = await fetch("https://api.cloudinary.com/v1_1/ddalveuw6/image/upload", {
                        method: "POST",
                        body: formData
                    });
                    const data = await response.json();
                    if (data.error) throw new Error(data.error.message);
                    updateData.image_url = data.secure_url;
                }

                const { error } = await supabase.from("posts").update(updateData).eq('id', postId);
                if (error) throw new Error(error.message);

                showAlert('success', 'Post updated successfully!');
                document.getElementById('editModal').style.display = 'none';
                loadPosts();
                updateStatus('Post updated');
            } catch (error) {
                showAlert('error', error.message || 'Error updating post.');
                updateStatus('Error');
            } finally {
                saveBtn.disabled = false;
            }
        });

        // Delete Modal
        function openDeleteModal(postId) {
            document.getElementById('deletePostId').value = postId;
            document.getElementById('deleteModal').classList.add('active');
            document.getElementById('deleteModal').style.display = 'flex';
            updateStatus('Confirming deletion');
        }

        document.getElementById('confirmDeleteBtn').addEventListener('click', async function() {
            const deleteBtn = this;
            deleteBtn.disabled = true;
            updateStatus('Deleting post...');

            try {
                const postId = document.getElementById('deletePostId').value;
                const { error } = await supabase.from("posts").delete().eq('id', postId);
                if (error) throw new Error(error.message);

                showAlert('success', 'Post deleted successfully!');
                document.getElementById('deleteModal').style.display = 'none';
                loadPosts();
                updateStatus('Post deleted');
            } catch (error) {
                showAlert('error', error.message || 'Error deleting post.');
                updateStatus('Error');
            } finally {
                deleteBtn.disabled = false;
            }
        });

        // Modal Close
        ['closeEditModal', 'cancelEditBtn', 'closeDeleteModal', 'cancelDeleteBtn', 'closeViewModal', 'closeViewBtn'].forEach(id => {
            document.getElementById(id).addEventListener('click', () => {
                const modal = document.getElementById(id.includes('Edit') ? 'editModal' : id.includes('Delete') ? 'deleteModal' : 'viewModal');
                modal.classList.remove('active');
                modal.style.display = 'none';
                updateStatus('Ready');
            });
        });

        document.getElementById('editFromViewBtn').addEventListener('click', function() {
            const postId = this.getAttribute('data-id');
            document.getElementById('viewModal').style.display = 'none';
            openEditModal(postId);
        });

        // Alerts
        function showAlert(type, message) {
            const alertSuccess = document.getElementById('alertSuccess');
            const alertError = document.getElementById('alertError');
            const errorMessage = document.getElementById('errorMessage');

            if (type === 'success') {
                alertSuccess.querySelector('span').textContent = message;
                alertSuccess.style.display = 'flex';
                setTimeout(() => alertSuccess.style.display = 'none', 3000);
            } else {
                errorMessage.textContent = message;
                alertError.style.display = 'flex';
                setTimeout(() => alertError.style.display = 'none', 3000);
            }
        }

        document.querySelectorAll('.alert-close').forEach(button => {
            button.addEventListener('click', function() {
                this.parentElement.style.display = 'none';
                updateStatus('Ready');
            });
        });

        // Status Bar
        function updateStatus(message) {
            document.getElementById('statusMessage').textContent = message;
        }
    </script>
</body>
</html>
